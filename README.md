[![Build Status](https://travis-ci.com/Otus-DevOps-2018-05/overmind88_infra.svg?branch=ansible-3)](https://travis-ci.com/Otus-DevOps-2018-05/overmind88_infra)

# overmind88_infra
overmind88 Infra repository

# ДЗ №3

bastion_IP = 35.204.213.127
someinternalhost_IP = 10.164.0.3

Подключение к someinternalhost в одну строчку:

`ssh -i ~/.ssh/appuser -A overmind88@35.204.213.127 -t ssh 10.164.0.3`

Подключение по алиасу someinternalhost:

В ~/.ssh/config прописать следующее:

```
Host someinternalhost
    HostName 10.164.0.3
    ForwardAgent yes
    User overmind88
    ProxyCommand ssh overmind88@35.204.213.127 nc %h %p
```

# ДЗ №4

testapp_IP = 35.205.80.235
testapp_port = 9292

Команда для добавления правила файрволла:
`gcloud compute firewall-rules create puma-default-server --target-tags="puma-server" --source-ranges="0.0.0.0/0" --allow tcp:9292`

Команда для запуска со startup-скриптом:

```
gcloud compute instances create reddit-app-2\
  --boot-disk-size=10GB \
  --image-family ubuntu-1604-lts \
  --image-project=ubuntu-os-cloud \
  --machine-type=g1-small \
  --tags puma-server \
  --restart-on-failure \
  --metadata-from-file startup-script=startup.sh

```

# ДЗ №5

Что было сделано:
- написал конфиг для packer-base, проверена его работоспособность, сделал VM на его основе и установил туда reddit-app
- добавил дополнительные параметры в конфиг packer, сделал файл с примером для переменных
- написал конфиг для packer-full, который использует packer-base и просто устанавливает в него приложение и настраивает его автозапуск с помощью systemd-unit, проверил его работоспособность, отладил возникшие проблемы

# ДЗ №6
Что было сделано:
- создано описание инфраструктуры для приложения reddit-app в terraform, с помощью provisioner's сделано разворачивание приложения
- добавлены дополнительные переменные в конфигурацию согласно самостоятельному заданию
- применён terraform fmt к файлам
- добавлен файл с примером переменных
- добавлены ssh-ключи для пользователей из доп. задания
- проверено, что происходит при выполнении terraform apply если был добавлен ещё один ключ через веб-интерфейс. Добавленный вручную ключ удаляется, остаётся конфигурация, соответствующая описаной в terraform

# ДЗ №7
Что было сделано:
- Освоено импортирование конфигурации из облака в стейт-файл
- Выполнена работа с параллельным созданием ресурсов и неявными зависимостями
- Инфраструктура была разделено по нескольким VM - одна машина с БД, другая с зависимостями для приложения
- Описание инарфструктуры было разбито по нескольким файлам
- После этого опсиание инфраструктуры было передело на работу через модули
- С помощью переиспользования модулей были реализованы окружения prod и stage
- Была выполнена работа с реестром модулей, проверено создание бакетов
- Первое задание со * - Настроено удалённое хранение стейтов prod и stage в бакете gcs. Проверена работоспособность лока при одновременном запуске из разных мест, для бакета включено версионирование.
- Второе задание - сделал провижнинг приложения, с передачей переменной DATABASE_URL через terraform template (включение/отключение провижнинга через переменную не делал)

# ДЗ №8
Что было сделано:
- Выполнение базовых команд ansible с помощью разным модулей (shell, command, systems,service, git)
- Написан playbook для клонирования git-репозитория. При наличии каталога назначения ansible не выкачивает репозиторий, при отсутствии - выкачивает
- Сделан inventory.json и проверена его работоспособность

# ДЗ №9
Что было сделано:
- Написан один плейбук, один сценарий
- Написан один плейбук, но много сценариев
- Вся логика разбита по некольким плейбукам, которые вызываются из site.yml
- Сделан динамический inventory через gce.py
- Добавлен пример файла gce.ini
- Packer теперь использует ansible
- Сделаны новые образы через packer
- Проверена работоспособность конфигурирования mongo и деплоя приложения через ansible

# ДЗ №10
Что было сделано:
- Плейбуки разбиты по ролям
- Описаны окружения stage и prod
- Добавлено использовании роли nginx
- Теперь приложение проксируется через nginx на 80 порт
- Настроено динамическое инвентори для обоих окружений
- Сделано создание пользователей с указанием их credentials в зашифрованых с помощью ansible-vault файлах
- Добавлена проверка packer, terraform, tflint, ansible-lint
